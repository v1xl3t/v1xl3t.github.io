// ===================================
// FINANCE TRACKER - PHASE 2
// Custom Categories Management
// ===================================

/**
 * Add a custom category to the monthly overview
 */
function addCustomCategory() {
    showModal(`
        <h2>Add Custom Category</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Create a custom category to track specific types of income or spending.
        </p>
        <form id="addCustomCategoryForm" style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Category Section:</label>
                <select id="customCategorySection" style="width: 100%; padding: 0.75rem; border-radius: 8px; 
                        border: 1px solid var(--border-color); background: var(--bg-primary); 
                        color: var(--text-primary);">
                    <option value="moneyIn">Money IN (Income)</option>
                    <option value="moneyOut">Money OUT (Spending)</option>
                </select>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Category Name:</label>
                <input type="text" id="customCategoryName" placeholder="e.g., Freelance Income, Gym Membership" required
                       style="width: 100%; padding: 0.75rem; border-radius: 8px; 
                              border: 1px solid var(--border-color); background: var(--bg-primary); 
                              color: var(--text-primary);">
                <small style="color: var(--text-secondary);">Use a clear, descriptive name</small>
            </div>
            
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Category ID:</label>
                <input type="text" id="customCategoryId" placeholder="e.g., freelanceIncome, gymMembership"
                       style="width: 100%; padding: 0.75rem; border-radius: 8px; 
                              border: 1px solid var(--border-color); background: var(--bg-primary); 
                              color: var(--text-primary);">
                <small style="color: var(--text-secondary);">Auto-generated from name if left blank. Use camelCase.</small>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn-primary">Add Category</button>
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    `);

    // Auto-generate ID from name
    document.getElementById('customCategoryName').addEventListener('input', (e) => {
        const name = e.target.value;
        const idField = document.getElementById('customCategoryId');
        if (!idField.value || idField.dataset.autoGenerated === 'true') {
            const generatedId = name
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+(.)/g, (match, char) => char.toUpperCase())
                .replace(/\s/g, '');
            idField.value = generatedId;
            idField.dataset.autoGenerated = 'true';
        }
    });

    document.getElementById('customCategoryId').addEventListener('input', (e) => {
        e.target.dataset.autoGenerated = 'false';
    });

    document.getElementById('addCustomCategoryForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const section = document.getElementById('customCategorySection').value;
        const name = document.getElementById('customCategoryName').value.trim();
        let id = document.getElementById('customCategoryId').value.trim();
        
        if (!name) {
            showToast('Please enter a category name', 'error');
            return;
        }
        
        // Generate ID if not provided
        if (!id) {
            id = name
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+(.)/g, (match, char) => char.toUpperCase())
                .replace(/\s/g, '');
        }
        
        // Validate ID format (camelCase, no spaces or special chars)
        if (!/^[a-z][a-zA-Z0-9]*$/.test(id)) {
            showToast('Category ID must be in camelCase format (e.g., myCustomCategory)', 'error');
            return;
        }
        
        // Check if ID already exists
        const existingCategory = tracker.data.categories[section === 'moneyIn' ? 'income' : 'spending']
            .find(cat => cat.id === id);
        
        if (existingCategory) {
            showToast('A category with this ID already exists', 'error');
            return;
        }
        
        tracker.saveState();
        
        // Add to categories definition
        const categoryType = section === 'moneyIn' ? 'income' : 'spending';
        tracker.data.categories[categoryType].push({
            id: id,
            name: name,
            editable: true,
            custom: true
        });
        
        // Initialize the category in all months for all years
        Object.keys(tracker.data.years).forEach(year => {
            const yearData = tracker.data.years[year];
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            months.forEach(month => {
                if (!yearData.monthly[section][month]) {
                    yearData.monthly[section][month] = {};
                }
                yearData.monthly[section][month][id] = 0;
            });
        });
        
        renderMonthlyView();
        closeModal();
        showToast(`Category "${name}" added successfully!`, 'success');
    });
}

/**
 * Manage existing categories
 */
function manageCategories() {
    const income = tracker.data.categories.income;
    const spending = tracker.data.categories.spending;
    
    let html = `
        <h2>Manage Categories</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Edit or remove custom categories. Built-in categories cannot be deleted.
        </p>
        
        <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-primary);">Income Categories</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
    `;
    
    income.forEach((cat, index) => {
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <div>
                    <strong>${cat.name}</strong>
                    <small style="color: var(--text-tertiary); margin-left: 0.5rem;">${cat.id}</small>
                    ${cat.custom ? '<span style="background: var(--accent-primary); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">CUSTOM</span>' : ''}
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    ${cat.editable ? `<button class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" 
                                              onclick="editCategoryName('income', ${index})">Rename</button>` : ''}
                    ${cat.custom ? `<button class="btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" 
                                            onclick="deleteCategory('income', ${index})">Delete</button>` : 
                                   '<span style="color: var(--text-tertiary); font-size: 0.85rem;">Built-in</span>'}
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
        
        <div style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem; color: var(--accent-secondary);">Spending Categories</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
    `;
    
    spending.forEach((cat, index) => {
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                <div>
                    <strong>${cat.name}</strong>
                    <small style="color: var(--text-tertiary); margin-left: 0.5rem;">${cat.id}</small>
                    ${cat.custom ? '<span style="background: var(--accent-secondary); color: white; padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">CUSTOM</span>' : ''}
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    ${cat.editable ? `<button class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" 
                                              onclick="editCategoryName('spending', ${index})">Rename</button>` : ''}
                    ${cat.custom ? `<button class="btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.85rem;" 
                                            onclick="deleteCategory('spending', ${index})">Delete</button>` : 
                                   '<span style="color: var(--text-tertiary); font-size: 0.85rem;">Built-in</span>'}
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button class="btn-primary" onclick="closeModal(); addCustomCategory();">+ Add New Category</button>
            <button class="btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `;
    
    showModal(html);
}

/**
 * Rename a category (inline version for Monthly Overview)
 */
function editCategoryInline(type, index) {
    const categoryType = type === 'income' ? 'income' : 'spending';
    const category = tracker.data.categories[categoryType][index];
    
    if (!category) return;
    
    const newName = prompt(`Rename "${category.name}" to:`, category.name);
    
    if (!newName || newName.trim() === '') return;
    if (newName === category.name) return;
    
    tracker.saveState();
    tracker.data.categories[categoryType][index].name = newName.trim();
    
    renderMonthlyView();
    showToast(`Category renamed to "${newName.trim()}"`, 'success');
}

/**
 * Rename a category
 */
function editCategoryName(type, index) {
    const categoryType = type === 'income' ? 'income' : 'spending';
    const category = tracker.data.categories[categoryType][index];
    
    if (!category) return;
    
    const newName = prompt(`Rename "${category.name}" to:`, category.name);
    
    if (!newName || newName.trim() === '') return;
    if (newName === category.name) return;
    
    tracker.saveState();
    tracker.data.categories[categoryType][index].name = newName.trim();
    
    renderMonthlyView();
    manageCategories(); // Refresh the modal
    showToast(`Category renamed to "${newName.trim()}"`, 'success');
}

/**
 * Delete a custom category
 */
function deleteCategory(type, index) {
    const categoryType = type === 'income' ? 'income' : 'spending';
    const category = tracker.data.categories[categoryType][index];
    
    if (!category || !category.custom) {
        showToast('Cannot delete built-in categories', 'error');
        return;
    }
    
    if (!confirm(`Delete category "${category.name}"? This will remove all data for this category across all years.`)) {
        return;
    }
    
    tracker.saveState();
    
    // Remove from categories
    tracker.data.categories[categoryType].splice(index, 1);
    
    // Remove from all months in all years
    const section = type === 'income' ? 'moneyIn' : 'moneyOut';
    Object.keys(tracker.data.years).forEach(year => {
        const yearData = tracker.data.years[year];
        const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
        
        months.forEach(month => {
            if (yearData.monthly[section][month]) {
                delete yearData.monthly[section][month][category.id];
            }
        });
    });
    
    renderMonthlyView();
    manageCategories(); // Refresh the modal
    showToast(`Category "${category.name}" deleted`, 'success');
}

/**
 * Update the monthly view rendering to include custom categories
 */
const originalRenderMonthlyView = window.renderMonthlyView;
window.renderMonthlyView = function() {
    const yearData = tracker.getYearData();
    const tbody = document.getElementById('monthlyTableBody');
    const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

    // Calculate all monthly totals first
    months.forEach(month => tracker.calculateMonthlyTotals(month));

    tbody.innerHTML = '';

    // SAVINGS row (new addition)
    const savingsRow = createMonthlyRow('Savings', 'savings', 'moneyOut', months, yearData, false);
    tbody.appendChild(savingsRow);

    // MONEY IN section
    const moneyInHeader = createCategoryHeader('MONEY IN', 'moneyIn');
    tbody.appendChild(moneyInHeader);

    const moneyInRow = createMonthlyRow('Total Money In', 'total', 'moneyIn', months, yearData, true, 'total-row');
    tbody.appendChild(moneyInRow);

    // Money IN subcategories (including custom)
    const incomeCategories = tracker.data.categories.income;
    incomeCategories.forEach((cat, catIndex) => {
        const row = createMonthlyRow(cat.name, cat.id, 'moneyIn', months, yearData, false, 'subcategory-row');
        
        // Add edit/delete buttons for editable categories
        if (cat.editable || cat.custom) {
            const firstCell = row.querySelector('td.sticky-col');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'inline-flex';
            buttonContainer.style.gap = '0.5rem';
            buttonContainer.style.marginLeft = '0.5rem';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-secondary';
            editBtn.style.padding = '0.125rem 0.5rem';
            editBtn.style.fontSize = '0.7rem';
            editBtn.textContent = 'âœï¸';
            editBtn.title = 'Rename category';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editCategoryInline('income', catIndex);
            };
            
            if (cat.custom) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-danger';
                deleteBtn.style.padding = '0.125rem 0.5rem';
                deleteBtn.style.fontSize = '0.7rem';
                deleteBtn.textContent = 'ðŸ—‘ï¸';
                deleteBtn.title = 'Delete category';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteCategory('income', catIndex);
                };
                buttonContainer.appendChild(deleteBtn);
            }
            
            buttonContainer.appendChild(editBtn);
            firstCell.appendChild(buttonContainer);
        }
        
        tbody.appendChild(row);
    });

    // Shift row for Money IN
    const moneyInShift = createShiftRow('Shift', 'moneyIn', months, yearData);
    tbody.appendChild(moneyInShift);

    // DEBT section
    const debtHeader = createCategoryHeader('DEBT', 'debt');
    tbody.appendChild(debtHeader);

    const debtRow = createMonthlyRow('Total Debt', 'total', 'debt', months, yearData, true, 'total-row');
    tbody.appendChild(debtRow);

    // Debt subcategories
    const debtCategories = [
        { label: 'Loan Balance', key: 'loanBalance' },
        { label: 'Credit Balance', key: 'creditBalance' }
    ];

    debtCategories.forEach(cat => {
        const row = createMonthlyRow(cat.label, cat.key, 'debt', months, yearData, false, 'subcategory-row');
        tbody.appendChild(row);
    });

    // Shift row for Debt
    const debtShift = createShiftRow('Shift', 'debt', months, yearData);
    tbody.appendChild(debtShift);

    // MONEY OUT section
    const moneyOutHeader = createCategoryHeader('MONEY OUT', 'moneyOut');
    tbody.appendChild(moneyOutHeader);

    const moneyOutRow = createMonthlyRow('Total Money Out', 'total', 'moneyOut', months, yearData, true, 'total-row');
    tbody.appendChild(moneyOutRow);

    // Money OUT subcategories (including custom)
    const spendingCategories = tracker.data.categories.spending;
    spendingCategories.forEach((cat, catIndex) => {
        const row = createMonthlyRow(cat.name, cat.id, 'moneyOut', months, yearData, false, 'subcategory-row');
        
        // Add edit/delete buttons for editable categories
        if (cat.editable || cat.custom) {
            const firstCell = row.querySelector('td.sticky-col');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'inline-flex';
            buttonContainer.style.gap = '0.5rem';
            buttonContainer.style.marginLeft = '0.5rem';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-secondary';
            editBtn.style.padding = '0.125rem 0.5rem';
            editBtn.style.fontSize = '0.7rem';
            editBtn.textContent = 'âœï¸';
            editBtn.title = 'Rename category';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editCategoryInline('spending', catIndex);
            };
            
            if (cat.custom) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-danger';
                deleteBtn.style.padding = '0.125rem 0.5rem';
                deleteBtn.style.fontSize = '0.7rem';
                deleteBtn.textContent = 'ðŸ—‘ï¸';
                deleteBtn.title = 'Delete category';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteCategory('spending', catIndex);
                };
                buttonContainer.appendChild(deleteBtn);
            }
            
            buttonContainer.appendChild(editBtn);
            firstCell.appendChild(buttonContainer);
        }
        
        tbody.appendChild(row);
    });

    // Shift row for Money OUT
    const moneyOutShift = createShiftRow('Shift', 'moneyOut', months, yearData);
    tbody.appendChild(moneyOutShift);

    // NOTES section
    const notesHeader = createCategoryHeader('NOTES', 'notes');
    tbody.appendChild(notesHeader);

    const notesRow = createNotesRow(months, yearData);
    tbody.appendChild(notesRow);
};

/**
 * Update the calculateMonthlyTotals to handle custom categories
 */
const originalCalculateMonthlyTotals = tracker.calculateMonthlyTotals.bind(tracker);
tracker.calculateMonthlyTotals = function(month) {
    const yearData = this.getYearData();
    const monthly = yearData.monthly;

    // Calculate Money IN total (including custom categories)
    const moneyIn = monthly.moneyIn[month];
    let incomeTotal = 0;
    tracker.data.categories.income.forEach(cat => {
        incomeTotal += moneyIn[cat.id] || 0;
    });
    moneyIn.total = incomeTotal;

    // Calculate DEBT total
    const debt = monthly.debt[month];
    debt.total = debt.loanBalance + debt.creditBalance;

    // Calculate Money OUT total (including custom categories)
    const moneyOut = monthly.moneyOut[month];
    let spendingTotal = 0;
    tracker.data.categories.spending.forEach(cat => {
        spendingTotal += moneyOut[cat.id] || 0;
    });
    // Add savings
    spendingTotal += moneyOut.savings || 0;
    moneyOut.total = spendingTotal;
};

// Hook into the add category button
document.getElementById('addMonthlyCategory')?.addEventListener('click', addCustomCategory);

// Hook into the manage categories button in settings
document.getElementById('manageCategoriesBtn')?.addEventListener('click', manageCategories);

console.log('âœ… Phase 2: Custom Categories Module Loaded');
